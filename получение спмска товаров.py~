import requests
from openpyxl import Workbook

BASE_URL = "https://labkabinet.bitrix24.ru/rest/6808/9wti8nc7t0j9r2c7/"
HEADERS = {"Content-Type": "application/json"}

def call_bitrix_method(method, params=None):
    url = f"{BASE_URL}{method}"
    response = requests.post(url, json=params or {}, headers=HEADERS)
    response.raise_for_status()
    return response.json().get("result", [])

def get_all_products():
    return call_bitrix_method("crm.product.list")

def get_product_details(product_id):
    return call_bitrix_method("crm.product.get", {"id": product_id})

def get_product_prices(product_id):
    return call_bitrix_method("catalog.price.list", {"filter": {"PRODUCT_ID": product_id}})

def get_catalog_product(product_id):
    return call_bitrix_method("catalog.product.get", {"id": product_id})

def export_to_excel(products):
    wb = Workbook()
    ws = wb.active
    ws.title = "Products"

    headers = set()
    rows = []

    for product in products:
        pid = product["ID"]
        details = get_product_details(pid)
        catalog_info = get_catalog_product(pid)
        prices = get_product_prices(pid)

        row_data = {}
        row_data.update(product)
        row_data.update(details or {})
        row_data.update(catalog_info or {})
        row_data["PRICES"] = prices

        headers.update(row_data.keys())
        rows.append(row_data)

    headers = list(headers)
    ws.append(headers)

    import json
    def safe_value(value):
        if isinstance(value, (dict, list)):
            return json.dumps(value, ensure_ascii=False)
        return value

    for row in rows:
        ws.append([safe_value(row.get(h, "")) for h in headers])

    wb.save("products_full.xlsx")
    print("‚úÖ –§–∞–π–ª products_full.xlsx —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω.")


def main():
    print("üì¶ –ü–æ–ª—É—á–∞–µ–º —Ç–æ–≤–∞—Ä—ã –∏–∑ Bitrix24...")
    products = get_all_products()
    print(f"üîó –ù–∞–π–¥–µ–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤: {len(products)}")
    export_to_excel(products)

if __name__ == "__main__":
    main()


